const tmi=require("tmi.js");require("dotenv").config();const axios=require("axios"),needle=require("needle"),{evaluate:evaluate}=require("decimal-eval"),{eightBall:eightBall}=require("./eightBall");let tweet,tweetId,degrees,celcius,pickupLine,videoTitle,videoId;async function getLatestTweet(){const e=process.env.TWITTER_BEARER_TOKEN,t=await needle("get","https://api.twitter.com/2/tweets/search/recent",{query:"from:g2chaotic -is:retweet","tweet.fields":"author_id"},{headers:{"User-Agent":"v2RecentSearchJS",authorization:`Bearer ${e}`}});if(!t.body)throw new Error("Unsuccessful request");tweet=t.body.data[0].text,tweetId=t.body.data[0].id,console.log("Got latest tweet data")}async function getDegrees(){try{const e=await axios.get(`http://api.openweathermap.org/data/2.5/weather?zip=90001&appid=${process.env.WEATHER_APP_ID}&units=imperial`);console.log("Got degrees data"),degrees=e.data.main.temp}catch(e){console.error(e)}}async function getCelcius(){try{const e=await axios.get(`http://api.openweathermap.org/data/2.5/weather?zip=90001&appid=${process.env.WEATHER_APP_ID}&units=metric`);console.log("Got celcius data"),celcius=e.data.main.temp}catch(e){console.error(e)}}async function getPickupLine(){try{const e=await axios.get("https://pickupline-api.herokuapp.com/");pickupLine=e.data.pickup_line,console.log("Got pickup line data")}catch(e){console.error(e)}}async function getLatestVideo(){try{const e=await axios.get(`https://youtube.googleapis.com/youtube/v3/search?part=snippet&channelId=UCgjXO8vYQO1_A-9diNrIsAQ&maxResults=1&order=date&key=${process.env.YOUTUBE_API_KEY}`);console.log("Got yt video data"),videoTitle=e.data.items[0].snippet.title,videoId=e.data.items[0].id.videoId}catch(e){console.error(e)}}getLatestTweet(),getDegrees(),getCelcius(),getPickupLine(),getLatestVideo();const client=new tmi.Client({connection:{reconnect:!0},identity:{username:process.env.TWITCH_BOT_USERNAME,password:process.env.TWITCH_ACCESS_TOKEN},channels:["tsm_imperialhal"]}),client2=new tmi.Client({connection:{reconnect:!0},identity:{username:process.env.TWITCH_BOT_USERNAME,password:process.env.TWITCH_ACCESS_TOKEN},channels:["chaoticmuch"]});let nowResponse,math;function isMathProblem(e){return/^(\d*\.?\d*)\s?[-+/*]\s?(\d*\.?\d*)$/g.test(e)}function performMath(e){math=evaluate(e)}client.connect(),client2.connect(),console.log("Listening for messages.."),client.on("message",((e,t,n,a)=>{"OversightEsports"==t["display-name"]&&(console.log(`${t["display-name"]}: ${n}`),nowResponse=n)}));let isWinner,entries={},giveawayIsActive=!1,tourneyIsActive=!1;setInterval((()=>{client2.say("#chaoticmuch",`/announce Watch chaotics recent youtube video, ${videoTitle} https://www.youtube.com/watch?v=${videoId}`),getLatestVideo()}),12e4),client2.on("message",((e,t,n,a)=>{if(!a){if(n.includes("!now")&&"!now off"!==n&&"StreamElements"!==t["display-name"]&&tourneyIsActive&&client2.say(e,`@${t.username}, ${nowResponse}`),"!now on"===n&&t.mod&&!tourneyIsActive&&(nowResponse="waiting for event data...",client2.say(e,`@${t.username}, turned on data for !now... fetching... :)`),tourneyIsActive=!0),"!now off"===n&&t.mod&&tourneyIsActive&&(nowResponse="there are currently no events happening.",client2.say(e,`@${t.username}, turned off data for !now`),tourneyIsActive=!1),n.includes("!pickupline")&&(client2.say(e,`@${t.username}, ${pickupLine}`),getPickupLine()),n.includes("@chaoticmuchbot")&&client2.say(e,`@${t.username}, go f*** yourself :)`),n.includes("!gamble")&&client2.say(e,`@${t.username}, the quickest way to earn R301 Beamerz is to bet against chaotic in predictions Kappa`),n.includes("!weather")&&(client2.say(e,`@${t.username}, it is currently ${degrees} degrees (${celcius} celcius) in Los Angeles for chaotic`),getDegrees(),getCelcius()),n.includes("!help")&&client2.say(e,`@${t.username}, streamelements commands: https://streamelements.com/chaoticmuch-7861/commands chaoticmuchbot commands: !now !livestats !weather !latesttweet !pickupline !8ball [question]`),n.includes("^")&&client2.say(e,"^^^"),isMathProblem(n)&&(performMath(n),client2.say(e,`@${t.username}, The answer is ${math}`)),n.includes("!latesttweet")&&(client.say(e,`@${t.username}, chaotics latest tweet was "${tweet}" https://twitter.com/G2Chaotic/status/${tweetId}`),getLatestTweet()),n.includes("!8ball")){const n=Math.floor(Math.random()*eightBall.length),a=eightBall[n];client2.say(e,`@${t.username}, ${a}`)}if(n.includes("!enter")&&entries[t.username]!==t.username&&giveawayIsActive&&!isWinner?(entries[t.username]=t.username,client.say(e,`You have been entered into the giveaway, @${t.username}`)):n.includes("!enter")&&entries[t.username]===t.username&&giveawayIsActive&&!isWinner?client.say(e,`You have already been entered into the giveaway, @${t.username}`):n.includes("!enter")&&isWinner&&giveawayIsActive&&client.say(e,`@${t.username}, the giveaway has passed :( @${isWinner} has already been chosen as our giveaway winner!`),"!giveaway on"===n&&t.mod&&!giveawayIsActive&&(client2.say(e,`@${t.username}, giveaway feature enabled. Use !enter to enter the giveaway :)`),giveawayIsActive=!0),"!giveaway off"===n&&t.mod&&giveawayIsActive&&(client2.say(e,`@${t.username}, giveaway feature disabled.`),giveawayIsActive=!1,isWinner=!1,entries={}),"!choosewinner"===n&&!0===t.mod&&!isWinner&&giveawayIsActive){const n=Object.values(entries),a=n[Math.floor(Math.random()*n.length)];isWinner=a,void 0!==isWinner?client.say(e,`We have a winner! @${a}, congratulations! Hope you're ready to claim your prize :)`):client.say(e,`@${t.username}, no one has entered the giveaway yet`)}else"!choosewinner"===n&&!0===t.mod&&isWinner&&giveawayIsActive&&client.say(e,`@${isWinner} has already been chosen as our giveaway winner! We appreciate everyone joining the giveaway! :)`);console.log(`${t["display-name"]}: ${n}`)}}));