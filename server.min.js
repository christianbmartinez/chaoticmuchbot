const tmi=require("tmi.js");require("dotenv").config();const axios=require("axios"),needle=require("needle"),{evaluate:evaluate}=require("decimal-eval"),twittertoken=process.env.TWITTER_BEARER_TOKEN,endpointUrl="https://api.twitter.com/2/tweets/search/recent";let tweet,tweetId;async function getLatestTweet(){const e=await needle("get",endpointUrl,{query:"from:g2chaotic -is:retweet","tweet.fields":"author_id"},{headers:{"User-Agent":"v2RecentSearchJS",authorization:`Bearer ${twittertoken}`}});if(!e.body)throw new Error("Unsuccessful request");tweet=e.body.data[0].text,tweetId=e.body.data[0].id,console.log("Got latest tweet data")}(async()=>{try{await getLatestTweet()}catch(e){console.log(e)}})();let degrees,celcius,apexStats="Failed to fetch current apex stats";async function getApexStats(){try{const e=await axios.get(`https://api.mozambiquehe.re/bridge?auth=${process.env.APEX_STATS_AUTH}&uid=1006162359940&platform=PC`);apexStats=`\n    Rank: ${e.data.global.rank.rankName}, \n    RP: ${e.data.global.rank.rankScore}, \n    Position:# ${e.data.global.rank.ladderPosPlatform}, \n    Legend: ${e.data.legends.selected.LegendName}, \n    Legend Kills: ${e.data.legends.selected.data[0].value}, \n    Skin: ${e.data.legends.selected.gameInfo.skin}, \n    Pose: ${e.data.legends.selected.gameInfo.pose}, \n    Frame: ${e.data.legends.selected.gameInfo.frame}`,console.log("Got apex data")}catch(e){console.error(e)}}async function getDegrees(){try{const e=await axios.get(`http://api.openweathermap.org/data/2.5/weather?zip=90001&appid=${process.env.WEATHER_APP_ID}&units=imperial`);console.log("Got degrees data"),degrees=e.data.main.temp}catch(e){console.error(e)}}async function getCelcius(){try{const e=await axios.get(`http://api.openweathermap.org/data/2.5/weather?zip=90001&appid=${process.env.WEATHER_APP_ID}&units=metric`);console.log("Got celcius data"),celcius=e.data.main.temp}catch(e){console.error(e)}}getApexStats(),getDegrees(),getCelcius();const client=new tmi.Client({connection:{reconnect:!0},identity:{username:process.env.TWITCH_BOT_USERNAME,password:process.env.TWITCH_ACCESS_TOKEN},channels:["TSM_ImperialHal"]}),client2=new tmi.Client({connection:{reconnect:!0},identity:{username:process.env.TWITCH_BOT_USERNAME,password:process.env.TWITCH_ACCESS_TOKEN},channels:["chaoticmuchbot"]});let nowResponse,math;function isMathProblem(e){return/^(\d*\.?\d*)\s?[-+/*]\s?(\d*\.?\d*)$/g.test(e)}function performMath(e){math=evaluate(e)}client.connect(),client2.connect(),console.log("Listening for messages.."),client.on("message",((e,t,a,n)=>{"OversightEsports"==t["display-name"]&&(console.log(`${t["display-name"]}: ${a}`),nowResponse=a)}));let isWinner,entries={},giveawayIsActive=!1,tourneyIsActive=!1;client2.on("message",((e,t,a,n)=>{if(!n){if(a.includes("!enter")&&entries[t.username]!==t.username&&giveawayIsActive&&!isWinner?(entries[t.username]=t.username,client.say(e,`You have been entered into the giveaway, @${t.username}`)):a.includes("!enter")&&entries[t.username]===t.username&&giveawayIsActive&&!isWinner?client.say(e,`You have already been entered into the giveaway, @${t.username}`):a.includes("!enter")&&isWinner&&giveawayIsActive&&client.say(e,`@${t.username}, the giveaway has passed :( @${isWinner} has already been chosen as our giveaway winner!`),"!giveaway on"===a&&t.mod&&!giveawayIsActive&&(client2.say(e,`@${t.username}, giveaway feature enabled. Use !enter to enter the giveaway :)`),giveawayIsActive=!0),"!giveaway off"===a&&t.mod&&giveawayIsActive&&(client2.say(e,`@${t.username}, giveaway feature disabled.`),giveawayIsActive=!1,isWinner=!1,entries={}),"!choosewinner"===a&&!0===t.mod&&!isWinner&&giveawayIsActive){const t=Object.values(entries),a=t[Math.floor(Math.random()*t.length)];isWinner=a,client.say(e,`We have a winner! @${a}, congratulations! Hope you're ready to claim your prize :)`)}else"!choosewinner"===a&&!0===t.mod&&isWinner&&giveawayIsActive&&client.say(e,`@${isWinner} has already been chosen as our giveaway winner! We appreciate everyone joining the giveaway! :)`);a.includes("!now")&&"!now off"!==a&&"StreamElements"!==t["display-name"]&&tourneyIsActive&&client2.say(e,`@${t.username}, ${nowResponse}`),"!now on"===a&&t.mod&&!tourneyIsActive&&(nowResponse="waiting for event data...",client2.say(e,`@${t.username}, turned on data for !now... fetching... :)`),tourneyIsActive=!0),"!now off"===a&&t.mod&&tourneyIsActive&&(nowResponse="there are currently no events happening.",client2.say(e,`@${t.username}, turned off data for !now`),tourneyIsActive=!1),a.includes("!livestats")&&(client2.say(e,`@${t.username}, ${apexStats}`),getApexStats()),a.includes("@chaoticmuchbot")&&client2.say(e,`@${t.username}, go f*** yourself :)`),a.includes("!gamble")&&client2.say(e,`@${t.username}, the quickest way to earn R301 Beamerz is to bet against chaotic in predictions Kappa`),a.includes("!weather")&&(client2.say(e,`@${t.username}, it is currently ${degrees} degrees (${celcius} celcius) in Los Angeles for chaotic`),getDegrees(),getCelcius()),a.includes("!help")&&client2.say(e,`@${t.username}, streamelements commands: https://streamelements.com/chaoticmuch-7861/commands chaoticmuchbot commands: !now !livestats !weather !latesttweet`),a.includes("^")&&client2.say(e,"^^^"),isMathProblem(a)&&(performMath(a),client2.say(e,`@${t.username}, The answer is ${math}`)),a.includes("!latesttweet")&&(client.say(e,`@${t.username}, chaotics latest tweet was "${tweet}" https://twitter.com/G2Chaotic/status/${tweetId}`),getLatestTweet()),console.log(`${t["display-name"]}: ${a}`)}}));